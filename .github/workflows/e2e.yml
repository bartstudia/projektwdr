name: E2E

on:
  pull_request:
    branches: [ "main" ]

jobs:
  e2e:
    runs-on: ubuntu-latest
    env:
      MONGODB_URI: ${{ secrets.MONGODB_URI }}
      JWT_SECRET: ${{ secrets.JWT_SECRET }}
      NODE_ENV: development
      E2E_USER_EMAIL: ${{ secrets.E2E_USER_EMAIL }}
      E2E_USER_PASSWORD: ${{ secrets.E2E_USER_PASSWORD }}
      E2E_ADMIN_EMAIL: ${{ secrets.E2E_ADMIN_EMAIL }}
      E2E_ADMIN_PASSWORD: ${{ secrets.E2E_ADMIN_PASSWORD }}
      E2E_LAKE_NAME: ${{ secrets.E2E_LAKE_NAME }}
      E2E_EMPTY_EMAIL: ${{ secrets.E2E_EMPTY_EMAIL }}
      E2E_EMPTY_PASSWORD: ${{ secrets.E2E_EMPTY_PASSWORD }}
      E2E_EMPTY_LAKE_NAME: ${{ secrets.E2E_EMPTY_LAKE_NAME }}
      PORT: 5000
      CLIENT_URL: http://localhost:3000
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install server deps
        working-directory: server
        run: npm install

      - name: Install client deps
        working-directory: client
        run: npm install --legacy-peer-deps

      - name: Install Playwright browsers
        working-directory: client
        run: npx playwright install --with-deps

      - name: Start backend
        working-directory: server
        run: npm run dev &

      - name: Start frontend
        working-directory: client
        run: npm start &

      - name: Wait for app
        run: npx wait-on http://localhost:3000 http://localhost:5000/api/health

      - name: Run E2E
        working-directory: client
        run: npm run e2e
